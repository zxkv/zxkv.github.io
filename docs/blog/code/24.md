# VUE3 åå°ç®¡ç†ç³»ç»Ÿã€Œè·¯ç”±é‰´æƒã€

### ğŸŒ å‰è¨€ï¼š

&emsp;&emsp;åœ¨â€œ**VUE3 åå°ç®¡ç†ç³»ç»Ÿã€Œæ¨¡æ¿æ„å»ºã€**â€æ–‡ç« ä¸­ï¼Œè¯¦ç»†çš„ä»‹ç»äº†æˆ‘ä½¿ç”¨ **vue3.0** å’Œ **vite2.0** æ„å»ºçš„åå°ç®¡ç†ç³»ç»Ÿï¼Œè™½ç„¶åªæ˜¯ç®€å•çš„ä¸€ä¸ªåå°ç®¡ç†ç³»ç»Ÿï¼Œå…¶ä¸­æ¶‰åŠçš„æŠ€æœ¯åŸºæœ¬éƒ½è¦†ç›–äº†ï¼ŒåŸºäº **vue3** çš„ â€**vue-router** å’Œ **vuex**ï¼Œä»¥åŠå€ŸåŠ©ç¬¬ä¸‰æ–¹å¼€æºæ’ä»¶æ¥å®ç° **vuex æ•°æ®æŒä¹…åŒ–**ã€‚å‰è¾¹åªæ˜¯ä»‹ç»äº† vue åå°ç®¡ç†ç³»ç»Ÿçš„é¡µé¢å¸ƒå±€ï¼Œä»¥åŠä¸€äº›å¸¸ç”¨çš„æ’ä»¶çš„ä½¿ç”¨ï¼Œå¦‚ï¼šå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ã€è§†é¢‘æ’­æ”¾å™¨ã€é¡µé¢æ»šåŠ¨æ¡ç¾åŒ–ï¼ˆå‰è¾¹å¿˜è®°ä»‹ç»äº†ï¼Œæ­¤æ¬¡æ–‡ç« ä¸­å°†ä¼šè¿›è¡Œæ·»åŠ å’Œè¡¥å……ï¼‰ã€‚

&emsp;&emsp;æœ¬æ¬¡æ–‡ç« ä¸»è¦ä»‹ç»çš„æ˜¯ vue-router çš„åŠ¨æ€åŒ¹é…å’ŒåŠ¨æ€æ ¡éªŒï¼Œæ¥å®ç°ä¸åŒè´¦å·ä¸åŒæƒé™ï¼Œé€šè¿‡å‰ç«¯æ¥å¯¹ç”¨æˆ·æƒé™è¿›è¡Œç›¸åº”çš„é™åˆ¶ï¼›åœ¨ä¸€äº›æ²¡æœ‰è®¿é—®æƒé™çš„è·¯å¾„ä¸‹è®¿é—®æ—¶ç»™äºˆç›¸åº”çš„æç¤ºä»¥åŠåç»­ç›¸åº”çš„è·³è½¬å¤åŸç­‰é€»è¾‘æ“ä½œã€‚ç”¨æˆ·é‰´æƒï¼Œå‰ç«¯å¯ä»¥è¿›è¡Œé™åˆ¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åå°æ¥å£æ•°æ®è¿›è¡Œé™åˆ¶ï¼Œä¹‹å‰å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°è¿‡é€šè¿‡åå°æ¥å£æ¥åŠ¨æ€æ¸²æŸ“è·¯ç”±çš„ï¼Œæ¥ä¸‹æ¥ä»‹ç»çš„æ˜¯çº¯å‰ç«¯æ¥åšè·¯ç”±è®¿é—®çš„é™åˆ¶ã€‚

### ğŸ€ è·¯ç”±é…ç½®ï¼š

```javascript title='Vue è·¯ç”±é…ç½®'
import Layout from "../layout/Index.vue";
import RouteView from "../components/RouteView.vue";

const layoutMap = [
	{
		path: "/",
		name: "Index",
		meta: { title: "æ§åˆ¶å°", icon: "home" },
		component: () => import("../views/Index.vue")
	},
	{
		path: "/data",
		meta: { title: "æ•°æ®ç®¡ç†", icon: "database" },
		component: RouteView,
		children: [
			{
				path: "/data/list",
				name: "DataList",
				meta: { title: "æ•°æ®åˆ—è¡¨", roles: ["admin"] },
				component: () => import("../views/data/List.vue")
			},
			{
				path: "/data/table",
				name: "DataTable",
				meta: { title: "æ•°æ®è¡¨æ ¼" },
				component: () => import("../views/data/Table.vue")
			}
		]
	},
	{
		path: "/admin",
		meta: { title: "ç”¨æˆ·ç®¡ç†", icon: "user" },
		component: RouteView,
		children: [
			{
				path: "/admin/user",
				name: "AdminAuth",
				meta: { title: "ç”¨æˆ·åˆ—è¡¨", roles: ["admin"] },
				component: () => import("../views/admin/AuthList.vue")
			},
			{
				path: "/admin/role",
				name: "AdminRole",
				meta: { title: "è§’è‰²åˆ—è¡¨" },
				component: () => import("../views/admin/RoleList.vue")
			}
		]
	},
	{
		path: "user",
		name: "User",
		hidden: true /* ä¸åœ¨ä¾§è¾¹å¯¼èˆªå±•ç¤º */,
		meta: { title: "ä¸ªäººä¸­å¿ƒ" },
		component: () => import("../views/admin/User.vue")
	},
	{
		path: "/error",
		name: "NotFound",
		hidden: true,
		meta: { title: "Not Found" },
		component: () => import("../components/NotFound.vue")
	}
];

const routes = [
	{
		path: "/login",
		name: "Login",
		meta: { title: "ç”¨æˆ·ç™»å½•" },
		component: () => import("../views/Login.vue")
	},
	{
		path: "/",
		component: Layout,
		children: [...layoutMap]
	},
	{ path: "/*", redirect: { name: "NotFound" } }
];

export { routes, layoutMap };
```

:::tip æç¤ºï¼š

-   æ­¤æ¬¡è·¯ç”±åˆ—è¡¨åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†æ˜¯é»˜è®¤è·¯ç”±ï¼Œå³æ— éœ€æƒé™æ ¡éªŒçš„è·¯ç”±è·¯å¾„ï¼ˆå¦‚ï¼šLogin ç™»å½•é¡µï¼‰ï¼›
-   å…¶ä¸­ layoutMap ä¸­çš„è·¯ç”±å…ƒç´ æ˜¯å…¨éƒ¨ä¸è·¯ç”±è·¯å¾„ç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼Œå³åŒ…è£¹æ‰€æœ‰ç”¨æˆ·æƒé™çš„è·¯å¾„è·¯ç”±ä¿¡æ¯ï¼›
-   è·¯ç”±é‰´æƒæœ€ç»ˆé™åˆ¶çš„å°±æ˜¯ layoutMap æ•°ç»„ä¸­çš„æ•°æ®å…ƒç´ ï¼Œå¹¶ä¸”è¿›è¡Œç›¸åº”çš„ç­›é€‰é™åˆ¶æ¥è¾¾åˆ°é™åˆ¶è·¯ç”±è®¿é—®çš„ç›®çš„ã€‚

:::

### ğŸš— è·¯ç”±æ‹¦æˆªï¼š

```javascript title="è·¯ç”±æ‹¦æˆª - vue-router4.x ç‰ˆæœ¬"
// vue-router4.0ç‰ˆå†™æ³•
import { createRouter, createWebHistory } from "vue-router";
import { decode } from "js-base64";
import { routes } from "./router";
import NProgress from "nprogress";
import "nprogress/nprogress.css";

NProgress.configure({ showSpinner: false });

const router = createRouter({
	history: createWebHistory(),
	routes: [...routes],
	scrollBehavior(to, from, savedPosition) {
		if (savedPosition) {
			return savedPosition;
		} else {
			return { top: 0 };
		}
	}
});

// è·¯ç”±æ‹¦æˆªä¸ä¸‹æ–¹vue-router3.xå†™æ³•ç›¸åŒ
```

```javascript title="è·¯ç”±æ‹¦æˆª - vue-router3.x ç‰ˆæœ¬"
// vue-router3.xç‰ˆå†™æ³•
import Vue from "vue";
import VueRouter from "vue-router";
import { decode } from "js-base64";
import { routes } from "./router";
import NProgress from "nprogress";
import "nprogress/nprogress.css";

NProgress.configure({ showSpinner: false });

Vue.use(VueRouter);

const router = new VueRouter({
	mode: "history",
	base: process.env.BASE_URL,
	routes: [...routes],
	scrollBehavior(to, from, savedPosition) {
		if (savedPosition) {
			return savedPosition;
		} else {
			return { top: 0 };
		}
	}
});

router.beforeEach((to, from, next) => {
	NProgress.start();
	const jwt = sessionStorage.getItem("jwt") || "";

	document.title = jwt ? (to.meta.title ? to.meta.title + " - ç®¡ç†åº”ç”¨" : "ç®¡ç†ç³»ç»Ÿ") : "ç³»ç»Ÿç™»å½•";
	if (to.path === "/login") {
		!!jwt ? next("/") : next();
	} else {
		if (from.path === "/login" && !jwt) {
			NProgress.done(true);
			next(false);
			return;
		}
		if (!!jwt) {
			if (to.meta.hasOwnProperty("roles")) {
				let roles = to.meta.roles || [],
					{ role } = jwt && JSON.parse(decode(jwt));
				roles.includes(role) ? next() : next("/error");
				return;
			}
			next();
		} else {
			next("/login");
		}
	}
});

router.afterEach(() => {
	NProgress.done();
});

export default router;
```

:::tip ğŸ“š æç¤º

-   ä¾æ®è®¿é—®çš„è·¯ç”±èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œè¿›è¡ŒåŠ¨æ€çš„è·¯ç”±æƒé™æ ¡éªŒï¼Œæœ‰è®¿é—®æƒé™çš„æ”¾è¿‡ï¼Œæ²¡æœ‰è®¿é—®æƒé™çš„è·¯ç”±è¿›è¡Œç›¸åº”çš„æ‹¦æˆªå¤„ç†ï¼›
-   nprogress ä¸ºè·¯ç”±è®¿é—®çš„è¿›åº¦æ¡ï¼Œè®¿é—®æ—¶æœ‰ç›¸åº”çš„è¿›åº¦æ¡æŒ‡ç¤ºï¼Œä¹Ÿæœ‰è½¬åŠ¨çš„å°èŠèŠ±ï¼ˆå³è·¯ç”±åŠ è½½æŒ‡ç¤ºå™¨ï¼‰å¯é€šè¿‡ç›¸å…³é…ç½®è¿›è¡Œç›¸å…³çš„é…ç½®ï¼›
-   å½“æœ‰ç”¨æˆ·ä¿¡æ¯æ—¶è®¿é—®â€œ**/login**â€æ—¶åˆ™é»˜è®¤é‡å®šå‘åˆ°ç³»ç»Ÿæ§åˆ¶å°é¡µï¼Œåä¹‹åˆ™ä¸è¿›è¡Œæ‹¦æˆªï¼Œè®©å…¶è·³è½¬è‡³ç™»å½•é¡µé¢ï¼›
-   å½“è®¿é—®éç™»å½•é¡µé¢æ—¶ï¼Œè¦è¿›è¡Œ role ç®¡ç†å‘˜æƒé™çš„æ ¡éªŒï¼Œæœ‰æƒé™åˆ™æ”¾è¿‡ï¼Œç»§ç»­å‘åæ‰§è¡Œï¼Œåä¹‹åˆ™é‡å®šå‘åˆ°â€œ**/error**â€é¡µé¢æç¤ºå…¶æ— æƒè®¿é—®å½“å‰è·¯å¾„ã€‚

:::

### ğŸ è·¯ç”±è¿‡æ»¤ï¼š

```javascript title="è·¯ç”±å¤„ç†"
/* å¤„ç†æƒé™ */
export const hasPermission = (route, role) => {
	if (route["meta"] && route.meta.hasOwnProperty("roles")) {
		return route.meta.roles.includes(role);
	}
	return true;
};

/* è¿‡æ»¤æ•°ç»„ */
export const filterAsyncRouter = (routers, role) => {
	let tmp = [];
	tmp = routers.filter(el => {
		if (hasPermission(el, role)) {
			if (el["children"] && el.children.length) {
				el.children = filterAsyncRouter(el.children, role);
			}
			return true;
		}
		return false;
	});
	return tmp;
};
```

:::info ğŸ‘€ æ³¨ï¼š
æ­¤ä¸¤å‡½æ•°ä¸ºå°è£…çš„è¿‡æ»¤æŒ‡å®šæƒé™çš„è·¯ç”±æ•°æ®ï¼Œè¿”å›è¿‡æ»¤åçš„æ•°æ®ï¼ˆå³å½“å‰è´¦å·æœ‰æƒè®¿é—®çš„é¡µé¢ï¼‰ï¼›
:::

### vuex å­˜å‚¨å’Œè¿‡æ»¤è·¯ç”±ä¿¡æ¯

```javascript title="vuex å¤„ç†"
import Vue from "vue";
import Vuex from "vuex";
import { layoutMap } from "../router/router";
import { filterAsyncRouter } from "../utils/tool";
import createPersistedState from "vuex-persistedstate";
import SecureLS from "secure-ls";
import { CLEAR_USER, SET_USER, SET_ROUTES } from "./mutation-types";

Vue.use(Vuex);

const state = {
	users: null,
	routers: []
};

const getters = {};

const mutations = {
	[CLEAR_USER](state) {
		state.users = null;
		state.routers.length = 0;
	},
	[SET_USER](state, payload) {
		state.users = payload;
	},
	[SET_ROUTES](state, payload) {
		state.routers = payload;
	}
};

const ls = new SecureLS({
	encodingType: "aes" /* åŠ å¯†æ–¹å¼ */,
	isCompression: false /* å‹ç¼©æ•°æ® */,
	encryptionSecret: "vue" /* åŠ å¯†å¯†é’¥ */
});

const actions = {
	clearUser({ commit }) {
		commit(CLEAR_USER);
	},
	setUser({ commit }, payload) {
		let deepCopy = JSON.parse(JSON.stringify(layoutMap)),
			accessedRouters = filterAsyncRouter(deepCopy, payload.role);
		commit(SET_USER, payload);
		commit(SET_ROUTES, accessedRouters);
	}
};

const myPersistedState = createPersistedState({
	key: "store",
	storage: window.sessionStorage,
	// storage: {
	//     getItem: state => ls.get(state),
	//     setItem: (state, value) => ls.set(state, value),
	//     removeItem: state => ls.remove(state)
	// } /* æ°¸ä¹…å­˜å‚¨ */
	reducer(state) {
		return { ...state };
	}
});

export default new Vuex.Store({
	state,
	getters,
	mutations,
	actions
	// plugins: [myPersistedState]
});
```

:::warning ğŸ‘€ æ³¨è§£ï¼š

-   **secure-ls** ä¸ºåŠ å¯†å·¥å…·å‡½æ•°ï¼ŒåŠ å¯†çº§åˆ«æ¯”è¾ƒé«˜ï¼Œä¸€èˆ¬ä¸å¯ç ´è§£ï¼ŒåŸºäºå¯†é’¥å’Œç§é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ï¼Œä½¿ç”¨è§„åˆ™è¯·å‚è€ƒ githubï¼›
-   **vuex-persistedstate** ä¸ºæŒä¹…åŒ–å¤„ç† vuex çŠ¶æ€ä½¿ç”¨çš„ï¼Œå­˜å‚¨æ–¹å¼ä¸»è¦æœ‰ sessionStorageã€localStorage ä»¥ cookiesï¼Œä¸€èˆ¬å¸¸ç”¨å‰ä¸¤ç§æ–¹å¼ï¼›
-   å€ŸåŠ©**vuex**æ¥éå†è¿‡æ»¤æŒ‡å®šæƒé™çš„è·¯ç”±ï¼Œç„¶ååœ¨ Menu.vue ä¸­è¿›è¡Œæ¸²æŸ“å’Œéå†ã€‚

:::

### ğŸ‰ è·¯ç”±åˆ—è¡¨æ¸²æŸ“ï¼š

```html title="åˆ—è¡¨ä»£ç ç¤ºä¾‹"
<template>
	<a-layout-sider class="sider" v-model="collapsed" collapsible :collapsedWidth="56">
		<div class="logo">
			<a-icon type="ant-design" />
		</div>
		<a-menu
			class="menu"
			theme="dark"
			mode="inline"
			:defaultOpenKeys="[defaultOpenKeys]"
			:selectedKeys="[$route.path]"
			:inlineIndent="16"
		>
			<template v-for="route in routers">
				<template v-if="!route['hidden']">
					<a-sub-menu v-if="route.children && route.children.length" :key="route.path">
						<span slot="title">
							<a-icon :type="route.meta['icon']" />
							<span>{{ route.meta.title }}</span>
						</span>
						<a-menu-item v-for="sub in route.children" :key="sub.path">
							<router-link :to="{ path: sub.path }">
								<a-icon v-if="sub.meta['icon']" :type="sub.meta['icon']" />
								<span>{{ sub.meta.title }}</span>
							</router-link>
						</a-menu-item>
					</a-sub-menu>
					<a-menu-item v-else :key="route.path">
						<router-link :to="{ path: route.path }">
							<a-icon :type="route.meta['icon']" />
							<span>{{ route.meta.title }}</span>
						</router-link>
					</a-menu-item>
				</template>
			</template>
		</a-menu>
	</a-layout-sider>
</template>

<script>
	import { mapState } from "vuex";

	export default {
		name: "Sider",
		data() {
			return {
				collapsed: false,
				defaultOpenKeys: ""
			};
		},
		computed: {
			...mapState(["routers"])
		},
		created() {
			this.defaultOpenKeys = "/" + this.$route.path.split("/")[1];
		}
	};
</script>

<style lang="less" scoped>
	.sider {
		height: 100vh;
		overflow: hidden;
		overflow-y: scroll;
		&::-webkit-scrollbar {
			display: none;
		}

		.logo {
			height: 56px;
			line-height: 56px;
			font-size: 30px;
			color: #fff;
			text-align: center;
			background-color: #002140;
		}

		.menu {
			width: auto;
		}
	}
</style>

<style>
	ul.ant-menu-inline-collapsed > li.ant-menu-item,
	ul.ant-menu-inline-collapsed > li.ant-menu-submenu > div.ant-menu-submenu-title {
		padding: 0 16px !important;
		text-align: center;
	}
</style>
```

:::danger â—ï¸ æ³¨ï¼š
è¯¥èœå•æ¸²æŸ“æ˜¯åŸºäº Vue2.x å’Œ[**Ant Design Vue**](https://www.antdv.com/docs/vue/introduce-cn/)æ¥ç¼–è¾‘å®ç°çš„ã€‚
:::

```html title="èœå• page å±•ç¤º"
<template>
	<el-aside :width="isCollapse ? `64px` : `200px`">
		<div class="logo">
			<img src="@/assets/img/avatar.png" alt="logo" draggable="false" />
			<p>Vite2 Admin</p>
		</div>
		<el-menu
			background-color="#001529"
			text-color="#eee"
			active-text-color="#fff"
			router
			unique-opened
			:default-active="route.path"
			:collapse="isCollapse"
		>
			<template v-for="item in routers" :key="item.name">
				<template v-if="!item['hidden']">
					<el-submenu v-if="item.children && item.children.length" :index="concatPath(item.path)">
						<template #title>
							<i :class="item.meta.icon"></i>
							<span>{{ item.meta.title }}</span>
						</template>
						<template v-for="sub in item.children" :key="sub.name">
							<el-menu-item :index="concatPath(item.path, sub.path)">
								<i :class="sub.meta['icon']"></i>
								<template #title>{{ sub.meta.title }}</template>
							</el-menu-item>
						</template>
					</el-submenu>
					<el-menu-item v-else :index="concatPath(item.path)">
						<i :class="item.meta['icon']"></i>
						<template #title>{{ item.meta.title }}</template>
					</el-menu-item>
				</template>
			</template>
		</el-menu>
		<div class="fold" @click="changeCollapse">
			<i v-show="!isCollapse" class="el-icon-d-arrow-left"></i>
			<i v-show="isCollapse" class="el-icon-d-arrow-right"></i>
		</div>
	</el-aside>
</template>

<script>
	import { computed, reactive, toRefs } from "vue";
	import { useRoute } from "vue-router";
	import { useStore } from "vuex";

	export default {
		setup() {
			const route = useRoute();
			const store = useStore();
			const state = reactive({ isCollapse: false });
			const routers = computed(() => store.state.routers);

			const changeCollapse = () => {
				state.isCollapse = !state.isCollapse;
			};

			const concatPath = (p_path, c_path = "") => {
				return `${p_path !== "" ? "/" + p_path : "/"}${c_path !== "" ? "/" + c_path : ""}`;
			};

			return {
				route,
				routers,
				concatPath,
				changeCollapse,
				...toRefs(state)
			};
		}
	};
</script>
```

:::tip ğŸ‘€ æ³¨ï¼š

-   è¯¥èœå•å¯¼èˆªæ˜¯åŸºäº vue3 å’Œæ”¯æŒ Vue3 ç‰ˆæœ¬çš„[**Element-Plus**](https://element-plus.gitee.io/#/zh-CN)å®ç°çš„ï¼Œè¯¦ç»†å‚æ•°é…ç½®è¯·å‚è€ƒ Element-plus å®˜ç½‘ï¼›
-   æ­¤å¤„è·å–çš„è·¯ç”±æ•°ç»„å³é‰´æƒè¿‡æ»¤åçš„è·¯ç”±æ•°ç»„æ•°æ®ï¼›æ­¤èœå•å°†ä¼šä¾æ®ç™»å½•ä¿¡æ¯åŠ¨æ€éå†ç”ŸæˆæŒ‡å®šèœå•æ•°æ®ã€‚

:::

### ğŸŒ æ€»ç»“ï¼š

&emsp;&emsp;ç»“åˆä¹‹å‰çš„æ¨¡æ¿ä»£ç ï¼Œå°±å¯ä»¥å®Œæ•´çš„æ­å»ºå‡ºä¸€ä¸ªå¸¦æœ‰å‰ç«¯æƒé™æ ¡éªŒçš„ vue åå°ç®¡ç†ç³»ç»Ÿï¼Œä¸»è¦æ˜¯æ¢³ç†æ¸…è·¯ç”±æ•°æ®å’Œè¿‡æ»¤åçš„è·¯ç”±é‰´æƒåçš„è·¯ç”±æ•°æ®ä¿¡æ¯ã€‚ä¸»è¦ä»£ç å°±æ˜¯ä¸Šè¿°å°è£…çš„è¿‡æ»¤å’Œæƒé™æ ¡éªŒå‡½æ•°ã€‚åç»­å°†æ”¾å¼€åå°æ¨¡æ¿ä»£ç ï¼Œæ¨¡æ¿ä»£ç å®Œå–„ä¸­......ğŸğŸğŸ
